```markdown
# Client-Side Encrypted Storage Utility (main.py)

## 概要

このユーティリティは、ローカルのファイルやフォルダをクライアントサイドで暗号化し、安全に保管するためのPythonスクリプトです。ファイルは指定したチャンクサイズに分割され、それぞれ個別のランダムパスワードとソルトを用いてAES-256-GCMアルゴリズムで暗号化されます。ディレクトリ構造と各ファイルの暗号化情報はJSONL形式で記録され、このJSONLファイル自体もユーザー指定のマスターパスワードで暗号化されます。

## 主な機能

* **強力な暗号化**: AES-256-GCM を使用してファイルデータを暗号化します。
* **ファイル分割**: 大きなファイルを50MBのチャンクに分割して処理します。
* **個別パスワード**: 各オリジナルファイルは、ランダムに生成された強力なパスワード（デフォルト120文字）で暗号化されます。 このパスワードは暗号化されたディレクトリ情報ファイル内に保存されます。
* **ディレクトリ構造の保存**: 元のディレクトリ構造、ファイル名、チャンク情報、および各ファイルの暗号化に使用されたソルトとパスワードをJSONLファイル (`dirinfo.json`) に記録します。
* **マスターキーによる保護**: 上記のJSONLファイル (`dirinfo.json`) は、ユーザーが設定するマスターパスワードでさらに暗号化され、`masterkey.enc` という名前で保存されます。 この暗号化に使用したソルトは `master_salt.txt` として別途保存されます。
* **暗号化・復号モード**: スクリプトは暗号化モード (`encrypt`) と復号化モード (`decrypt`) の両方をサポートします。

## 必要なもの

* Python 3.x
* PyCryptodome ライブラリ

PyCryptodomeは以下のコマンドでインストールできます:
```bash
pip install pycryptodome
```

## 依存ファイル

このスクリプト (`main.py`) は、以下の補助スクリプトと同じディレクトリに配置されている必要があります。

* `AES256GCM.py`: AES-256-GCM暗号化・復号処理、鍵導出機能を提供します。
* `gen_rndstring.py`: ランダムな文字列（パスワード生成用）を生成する機能を提供します。

## 使用方法

スクリプトはコマンドラインから実行します。

### 基本構文

```bash
python main.py <引数1> <引数2> <マスターパスワード> [モード]
```

### 引数の説明

* **`<引数1>`**:
    * **暗号化モード時 (`encrypt`)**: 暗号化したいファイルやフォルダが含まれる**ターゲットディレクトリ**のパス。
    * **復号化モード時 (`decrypt`)**: 復元されたファイルを出力する先の**復元先ベースディレクトリ**のパス。
* **`<引数2>`**:
    * **暗号化モード時 (`encrypt`)**: 暗号化されたファイル（チャンク、`masterkey.enc`, `master_salt.txt`）を保存する**出力ディレクトリ**のパス。
    * **復号化モード時 (`decrypt`)**: 暗号化されたファイル（チャンク、`masterkey.enc`, `master_salt.txt`）が格納されている**暗号化ファイル格納ディレクトリ**のパス。
* **`<マスターパスワード>`**:
    * `dirinfo.json` を暗号化・復号化するためのマスターパスワードです。**このパスワードは非常に重要ですので、忘れないように安全に記憶・管理してください。**
* **`[モード]`**: (オプション、省略した場合は `encrypt` がデフォルトとなります)
    * `encrypt`: 暗号化処理を実行します。
    * `decrypt`: 復号化処理を実行します。

### 暗号化 (Encrypt) モード

指定されたターゲットディレクトリ内の全ファイルを検索し、暗号化して出力ディレクトリに保存します。

**コマンド例:**

```bash
python main.py ./my_documents ./encrypted_archive "MyVeryStrongMasterPassword!@#" encrypt
```

* `./my_documents`: 暗号化したいファイル群が含まれるディレクトリ。
* `./encrypted_archive`: 暗号化されたチャンクファイル、`masterkey.enc`、`master_salt.txt` が保存されるディレクトリ。
* `"MyVeryStrongMasterPassword!@#"`: マスターパスワード。引用符はパスワードにスペースや特殊文字が含まれる場合に推奨されます。

**処理の流れ (暗号化モード):**

1.  指定された出力ディレクトリが存在しない場合は作成します。
2.  一時的なディレクトリ情報ファイル `dirinfo.json` が（スクリプト実行カレントディレクトリに）存在する場合、事前に削除します。
3.  ターゲットディレクトリ内のファイルを再帰的に探索します。
    * ただし、出力ディレクトリ内の `masterkey.enc` や `master_salt.txt`、および一時的な `dirinfo.json` 自体は暗号化対象から除外されます。
4.  見つかった各ファイルに対して以下の処理を行います:
    * ランダムな120文字のファイル固有パスワードを生成します。
    * ファイルを50MB単位のチャンクに分割します。
    * 各チャンクは、ファイル固有パスワードとランダムに生成されたソルトから導出された鍵を使い、AES-256-GCM方式で暗号化されます。
    * 暗号化された各チャンクは、出力ディレクトリ内にハッシュ名 (`<ハッシュ値>.enc`) で保存されます。
    * 元のファイル名、パス、チャンクのIDとファイル名、ファイル固有パスワード、およびベースソルトなどの情報が、カレントディレクトリの一時的な `dirinfo.json` ファイルにJSONL形式で追記されます。
5.  すべての対象ファイルの処理が完了した後、カレントディレクトリに生成された `dirinfo.json` が存在する場合:
    * この `dirinfo.json` ファイル自体が、ユーザー指定のマスターパスワードと新たにランダム生成されたマスターソルトを用いてAES-256-GCMで暗号化されます。
    * 暗号化された `dirinfo.json` は、出力ディレクトリに `masterkey.enc` という名前で保存されます。
    * 使用されたマスターソルトは、出力ディレクトリに `master_salt.txt` という名前で保存されます。
    * カレントディレクトリの一時的な `dirinfo.json` は削除されます。

### 復号化 (Decrypt) モード

指定された暗号化ファイル格納ディレクトリから `masterkey.enc` と `master_salt.txt` を読み込み、マスターパスワードを使用してディレクトリ情報 (`dirinfo.json` の内容) を復号します。その後、その情報に基づいて各ファイルのチャンクを復号し、元のファイルとディレクトリ構造を復元先ベースディレクトリに再構築します。

**コマンド例:**

```bash
python main.py ./restored_documents ./encrypted_archive "MyVeryStrongMasterPassword!@#" decrypt
```

* `./restored_documents`: 復元されたファイルが出力されるディレクトリ。
* `./encrypted_archive`: 暗号化されたチャンクファイル、`masterkey.enc`、`master_salt.txt` が保存されているディレクトリ。
* `"MyVeryStrongMasterPassword!@#"`: 暗号化時に使用したマスターパスワード。

**処理の流れ (復号化モード):**

1.  復元先ベースディレクトリが存在しない場合は作成します。
2.  暗号化ファイル格納ディレクトリから `master_salt.txt` を読み込みます。
3.  マスターパスワードと読み込んだマスターソルトを使い、暗号化ファイル格納ディレクトリ内の `masterkey.enc` を復号して、`dirinfo.json` の内容（JSONL形式の文字列）を取得します。
4.  復号された `dirinfo.json` の内容を1行ずつ解析し、ファイルごとの情報を再構築します。
    * 各レコードには、元のファイル名、元のパス、チャンクID、チャンクのファイル名、そのファイルの暗号化に使用されたパスワードとベースソルトが含まれています。
5.  ファイルごとに、記録されているパスワードとベースソルトを用いて各暗号化チャンク (`.enc` ファイル) を復号し、結合します。
6.  元のディレクトリ構造に従って、復号されたファイルが復元先ベースディレクトリに保存されます。

## 注意事項

* **マスターパスワードの管理**: マスターパスワードを忘れると、`masterkey.enc`（暗号化された `dirinfo.json`）を復号できず、結果として全ての暗号化データにアクセスできなくなります。非常に慎重に管理してください。
* **ソルトファイルの管理**: `master_salt.txt` は `masterkey.enc` とセットで保管する必要があります。これが失われると、マスターパスワードがあっても `masterkey.enc` を正しく復号できません。
* **依存ファイルの配置**: `AES256GCM.py` と `gen_rndstring.py` は `main.py` と同じディレクトリに配置してください。
* **ファイルパス**: パスにスペースや特殊文字が含まれる場合は、コマンドラインでパスを引用符で囲んでください。
* **既存ファイルの衝突**: 復号時に復元先ディレクトリに同名のファイルやディレクトリが存在する場合、上書きされる可能性があります（現在のスクリプトでは明示的な上書き確認はありません）。重要なデータがある場合は、事前にバックアップを取るか、空のディレクトリに復元することを推奨します。
* **エラー処理**: スクリプトには基本的なエラーメッセージが含まれていますが、全ての状況を網羅しているわけではありません。問題が発生した場合は、コンソールの出力を確認してください。

## 今後の改善案（例）

* 圧縮機能の統合 (`compress`関数は定義されていますが、暗号化パイプラインには未組み込み)。
* GUIフロントエンドの開発。
* より詳細なエラーハンドリングとロギング。
* チャンクごとのハッシュチェックによる改ざん検知強化。
```
